"use strict";angular.module("cms.controllers").controller("eventCtrl",["genService","MenuService","$scope","$timeout",function(e,t,n,a){t.update("Veranstaltungen"),n.loadingEvents=!0,e.getAllObjects("locations").then(function(e){n.allLocations=e,a(function(){n.loadingEvents=!1},300)}),e.getAllObjects("events").then(function(e){n.allEvents=e})}]).controller("eventDetailCtrl",["MenuService","$scope","$routeParams","$timeout","$location","genService","toaster","dateFilter","$moment",function(e,t,n,a,i,r,l,o,s){e.update("Veranstaltungen");var u,d=s();t.apiPath="events",t.menuName="Veranstaltung bearbeiten",t.deleteMsg="Löschen",t.eventStartDate=d.format("DD.MM.YYYY"),t.eventStartTime=d.format("HH.mm"),t.eventEndDate=d.format("DD.MM.YYYY"),t.eventEndTime=d.add(1,"h").format("HH.mm"),t.event={},t.event.description="",r.getObjectById("events",n.eventId).then(function(e){e||(l.pop("error",null,"Uups. Der angeforderte Event exisitert nicht (mehr)."),i.path("/events")),t.event=e;var n=new Date(t.event.start_date),a=new Date(t.event.end_date);t.eventStartDate=o(n,"dd.MM.yyyy"),t.eventEndDate=o(a,"dd.MM.yyyy"),t.eventStartTime=("0"+n.getHours()).substr(-2)+":"+("0"+n.getMinutes()).substr(-2),t.eventEndTime=("0"+a.getHours()).substr(-2)+":"+("0"+a.getMinutes()).substr(-2)}),r.getAllObjects("repeatOptions").then(function(e){t.allRepeatOptions=e}),r.getAllObjects("files").then(function(e){t.allFiles=[{id:-1,name:"Kein Anhang"}],e.forEach(function(e){t.allFiles.push(e)})}),r.getAllObjects("locations").then(function(e){t.allLocations=[{id:-1,name:"Kein Veranstaltungsort"}],e.forEach(function(e){t.allLocations.push(e)})}),t.deleteMsg="Event löschen",t.ctr=5,t.cancelled=!1,t.saveEvent=function(e){if(!e.name)return void l.pop("warning",null,"Der Eventname muss angegeben werden");if(!t.eventStartDate)return void l.pop("warning",null,"Das Startdatum muss angegeben werden");if(!t.eventStartTime)return void l.pop("warning",null,"Die Startzeit muss angegeben werden");if(!t.eventEndTime)return void l.pop("warning",null,"Die Endzeit muss angegeben werden");angular.isString(e.file)&&(e.file=JSON.parse(e.file),-1===e.file.id&&(e.file=null)),angular.isString(e.location)&&(e.location=JSON.parse(e.location),-1===e.location.id&&(e.location=null));var n=s(t.eventStartDate+" "+t.eventStartTime,"MM.DD.YYYY HH:mm"),o=s(t.eventEndDate+" "+t.eventEndTime,"MM.DD.YYYY HH:mm");return n.isValid()?o.isValid()?(e.start_date=n.format(),e.end_date=o.format(),t.loading=!0,void r.updateObject("events",e).then(function(){l.pop("success",null,"Event wurde aktualisiert"),u=a(function(){i.path("/events"),t.loading=!1},2500)})):void l.pop("warning",null,"Das Enddatum ist invalid"):void l.pop("warning",null,"Das Startdatum ist invalid")},t.$on("$locationChangeStart",function(){a.cancel(u)})}]).controller("eventAddCtrl",["genService","MenuService","$scope","$location","$timeout","toaster","$moment",function(e,t,n,a,i,r,l){t.update("Veranstaltungen");var o,s=l();n.apiPath="events",n.menuName="Veranstaltung hinzufügen",n.eventStartDate=s.format("DD.MM.YYYY"),n.eventStartTime=s.format("HH.mm"),n.eventEndDate=s.format("DD.MM.YYYY"),n.eventEndTime=s.add(1,"h").format("HH.mm"),n.event={description:""},e.getEmptyObject("event").then(function(e){e||(r.pop("error",null,"Der angeforderte Event exisitert nicht (mehr)."),a.path("/events")),n.event=e}),e.getAllObjects("repeatOptions").then(function(e){n.allRepeatOptions=e}),e.getAllObjects("files").then(function(e){n.allFiles=[{id:-1,name:"Kein Anhang"}],e.forEach(function(e){n.allFiles.push(e)})}),e.getAllObjects("locations").then(function(e){n.allLocations=[{id:-1,name:"Kein Veranstaltungsort"}],e.forEach(function(e){n.allLocations.push(e)})}),n.cancelled=!1,n.saveEvent=function(t){if(!t.name)return void r.pop("warning",null,"Der Eventname muss angegeben werden");if(!n.eventStartDate)return void r.pop("warning",null,"Das Startdatum muss angegeben werden");if(!n.eventStartTime)return void r.pop("warning",null,"Die Startzeit muss angegeben werden");if(!n.eventEndTime)return void r.pop("warning",null,"Die Endzeit muss angegeben werden");angular.isString(t.file)&&(t.file=JSON.parse(t.file),-1===t.file.id&&(t.file=null)),angular.isString(t.location)&&(t.location=JSON.parse(t.location),-1===t.location.id&&(t.location=null));var s=l(n.eventStartDate+" "+n.eventStartTime,"MM.DD.YYYY HH:mm"),u=l(n.eventEndDate+" "+n.eventEndTime,"MM.DD.YYYY HH:mm");return s.isValid()?u.isValid()?(t.start_date=s.format(),t.end_date=u.format(),n.loading=!0,void e.insertObject("events",t).then(function(){r.pop("success",null,"Event wurde aktualisiert"),o=i(function(){a.path("/events"),n.loading=!1},2500)})):void r.pop("warning",null,"Das Enddatum ist invalid"):void r.pop("warning",null,"Das Startdatum ist invalid")},n.$on("$locationChangeStart",function(){i.cancel(o)})}]);