"use strict";angular.module("cms.controllers").controller("locationDetailCtrl",["genService","MenuService","$scope","$routeParams","$timeout","$location","$log","$q","toaster",function(e,o,n,t,a,i,s,r,l){o.update("Veranstaltungen");var c,d,g,u,m,p=new google.maps.InfoWindow,f=0,h=0;n.addressIsLoading=!1,n.mapMessage="Die Adresse wird gesucht...",n.noResultsFound=!1,n.timeDifference=0,n.apiPath="locations",n.menuName="Veranstaltungsort bearbeiten",n.deleteMsg="Löschen",e.getObjectById("locations",t.locationId).then(function(e){e||(l.pop("error",null,"Uups. Der angeforderte Veranstaltungsort exisitert nicht (mehr)."),i.path("/locations")),n.location=e,n.initializeMap()}),n.saveLocation=function(o){return o.name?(n.loading=!0,void e.updateObject("locations",o).then(function(){l.pop("success",null,"Veranstaltungsort wurde aktualisiert"),c=a(function(){i.path("/events"),n.loading=!1},2500)})):void l.pop("warning",null,"Der Veranstaltungsort muss angegeben werden")},n.$on("$locationChangeStart",function(){a.cancel(c)}),n.initializeMap=function(){d=new google.maps.Geocoder;var e=new google.maps.LatLng(n.location.latitude,n.location.longitude),o={zoom:16,center:e,mapTypeId:"roadmap",panControl:!1,zoomControl:!0,scaleControl:!1,streetViewControl:!1};g=new google.maps.Map(document.getElementById("map-canvas"),o),u=new google.maps.Marker({position:e,map:g}),p.setContent(n.location.address),p.open(g,u)},n.checkTypeSpeed=function(){h=(new Date).getTime(),0!==f&&(n.timeDifference=h-f,n.debugModus&&s.log(n.timeDifference)),f=h},n.$watch("timeDifference",function(){n.noResultsFound=!1,n.timeDifference&&(n.addressIsLoading=!0,m&&a.cancel(m),n.timeDifference>800?n.geocode():m=a(n.geocode,800))}),n.geocode=function(){var e,o=r.defer();d.geocode({address:n.location.address},function(t,a){a===google.maps.GeocoderStatus.OK?(e={lat:t[0].geometry.location.lat(),lng:t[0].geometry.location.lng(),formattedAddress:t[0].formatted_address},o.resolve()):(n.noResultsFound=!0,n.errorMsg="Keine Resultate gefunden",n.addressIsLoading=!1,n.location.longitude=0,n.location.latitude=0),o.promise.then(function(){n.codeLatLng(e.lat,e.lng)})})},n.codeLatLng=function(e,o){var t=r.defer(),a=new google.maps.LatLng(e,o);d.geocode({latLng:a},function(e,o){o===google.maps.GeocoderStatus.OK?e[1]?(g.setZoom(16),g.setCenter(a),u=new google.maps.Marker({position:a,map:g}),p.setContent(e[1].formatted_address),p.open(g,u),t.resolve()):n.mapMessage="Keine Resultate gefunden":(n.mapMessage="Ein Problem ist aufgetreten. Bitte versuche es nocheinmal",console.error("Geocoder failed due to: "+o))}),t.promise.then(function(){n.location.longitude=o,n.location.latitude=e,n.addressIsLoading=!1})}}]).controller("locationAddCtrl",["genService","MenuService","$scope","$location","$timeout","$log","$q","toaster",function(e,o,n,t,a,i,s,r){o.update("Veranstaltungen");var l;n.apiPath="locations",n.menuName="Veranstaltungsort hinzufügen",e.getEmptyObject("location").then(function(e){n.initializeMap(),n.location=e}),n.saveLocation=function(o){return o.name?(n.loading=!0,void e.insertObject("locations",o).then(function(){r.pop("success",null,"Ort wurde hinzugefügt"),l=a(function(){t.path("/events"),n.loading=!1},2500)})):void r.pop("warning","Ort","Der Ort muss angegeben werden")},n.$on("$locationChangeStart",function(){a.cancel(l)}),n.addressIsLoading=!1,n.mapMessage="Die Adresse wird gesucht...",n.noResultsFound=!1,n.timeDifference=0;var c,d,g,u,m=new google.maps.InfoWindow,p=0,f=0;n.initializeMap=function(){c=new google.maps.Geocoder;var e=new google.maps.LatLng(46.85726210000001,9.526730499999985),o={zoom:10,center:e,mapTypeId:"roadmap",panControl:!1,zoomControl:!0,scaleControl:!1,streetViewControl:!1};d=new google.maps.Map(document.getElementById("map-canvas"),o)},n.checkTypeSpeed=function(){f=(new Date).getTime(),0!==p&&(n.timeDifference=f-p,n.debugModus&&i.log(n.timeDifference)),p=f},n.$watch("timeDifference",function(){n.noResultsFound=!1,n.timeDifference&&(n.addressIsLoading=!0,u&&a.cancel(u),n.timeDifference>800?n.geocode():u=a(n.geocode,800))}),n.geocode=function(){var e,o=s.defer();c.geocode({address:n.location.address},function(t,a){a===google.maps.GeocoderStatus.OK?(e={lat:t[0].geometry.location.lat(),lng:t[0].geometry.location.lng(),formattedAddress:t[0].formatted_address},o.resolve()):(n.noResultsFound=!0,n.errorMsg="Keine Resultate gefunden",n.addressIsLoading=!1,n.location.longitude=0,n.location.latitude=0),o.promise.then(function(){n.codeLatLng(e.lat,e.lng)})})},n.codeLatLng=function(e,o){var t=s.defer(),a=new google.maps.LatLng(e,o);c.geocode({latLng:a},function(e,o){o===google.maps.GeocoderStatus.OK?e[1]?(d.setZoom(16),d.setCenter(a),g=new google.maps.Marker({position:a,map:d}),m.setContent(e[1].formatted_address),m.open(d,g),t.resolve()):n.mapMessage="Keine Resultate gefunden":(n.mapMessage="Ein Problem ist aufgetreten. Bitte versuche es nocheinmal",console.error("Geocoder failed due to: "+o))}),t.promise.then(function(){n.location.longitude=o,n.location.latitude=e,n.addressIsLoading=!1})}}]);